machine:
  services:
    - docker
dependencies:
  pre:
    - if ! chef -v; then
        curl -LO https://omnitruck.chef.io/install.sh && sudo bash ./install.sh -P chefdk;
      fi
    - chef gem install specific_install
    - sudo chef gem specific_install kitchen-docker -l http://github.com/peterabbott/kitchen-docker.git -b v1.6.4
    - sudo chef gem uninstall chefspec
    - chef gem install chefspec:4.0.1
test:
  override:
    - chef exec foodcritic cookbooks/circleci -X spec -f any
    - aws configure set default.region us-east-1
    - aws cloudformation validate-template --template-body file://cloudformation/chef_deploy.yml
deployment:
  development:
    branch: master
    commands:
      berks package cookbooks.tar.gz -b ./cookbooks/circleci/Berksfile
      aws s3 cp cookbooks.tar.gz s3://ponzio-test/cookbooks.tar.gz
      aws s3 cp node.json s3://ponzio-test/node.json
      aws s3 cp solo.rb s3://ponzio-test/solo.rb
      aww s3 cp bootstrap.sh s3://ponzio-test/bootstrab.sh
